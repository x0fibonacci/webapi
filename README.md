# webapi

**Тестовое задание (Rust)**

Необходимо создать веб сервер, который будет иметь функционал создания пользователя, авторизации по логину и паролю, изменение пользователя. По пользователю должна храниться следующая информация:</p>

- Имя</p>

- Логин (почтовый адрес)</p>

- Пароль</p>

- Возраст</p>

В качестве веб фреймворка должен выступать Hyper, асинхронная среда выполнения tokio. Пользователи должны храниться в БД postgres. Сам Postgres должен быть запущен в docker, запускаться должен скриптом bash. Для работы с Postgres необходимо использовать crate sqlx. Из функционала должно быть:</p>

- 3 ручки API на создание, авторизацию и изменение пользователя. Создание пользователя не требует наличие JWT токена в запросе, остальные операции требуют. Пользователь может изменять только собственные данные в бд.</p>

- Пароль пользователя должен храниться в БД в зашифрованном виде (функцией sha-256). Secret должен загружаться из env при запуске сервера.</p>

- Функция проверки пароля не должна блокировать асинхронный executor.</p>

- Нужно написать Middleware для проверки JWT токена пользователя. Secret токена должен получаться из env при запуске приложения. Само значение точена должно быть в Header X-User-Access-Token http запроса.</p>

**Ошибки**:

- В случае не успешной авторизации должна возвращаться ошибка 401 с текстом authirization error.</p>

- 500 код на ошибку сервера</p>

- Ошибки в коде должны быть представлены в виде enum, который реализует трейт error для быстрого проброса ошибки в handler с помощью знака ?</p>

**Архитектура**:

Код Логически должен быть разделен на модули Контроллеры, Сервисы, Репозитории. Придерживаемся низкой связанности компонентов системы согласно чистой архитектуре.</p>

Код должен быть отформатирован и линтер clippy не должен выдавать предупреждений.</p>

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd user-service
Установите зависимости Rust:
```
cargo build
```
Создайте файл .env в корне проекта:
```env

DATABASE_URL=postgres://user:password@localhost:5432/user_service
JWT_SECRET=your_jwt_secret_here
PASSWORD_SECRET=your_password_secret_here
```
Запустите PostgreSQL с помощью Docker:
```
chmod +x start_postgres.sh
./start_postgres.sh
```
Запустите приложение:
```bash
cargo run
```
Сервер будет доступен по адресу http://localhost:8080.
```
API
POST /api/users
```
Создает нового пользователя. Не требует JWT.

Запрос:

```json
{
  "name": "Иван Иванов",
  "email": "ivan@example.com",
  "password": "password123",
  "age": 25
}
```
Ответ (200):

```json

{
  "id": "uuid-string",
  "name": "Иван Иванов",
  "email": "ivan@example.com",
  "age": 25
}
```
POST /api/login
Авторизует пользователя и возвращает JWT.

Запрос:

```json

{
  "email": "ivan@example.com",
  "password": "password123"
}
```
Ответ (200):

```json

{
  "token": "jwt-token"
}
```
Ошибка (401):

```
authorization error
PATCH /api/users/me
```
Обновляет данные текущего пользователя. Требует JWT в заголовке X-User-Access-Token.

Запрос:

```json

{
  "name": "Иван Петров",
  "age": 26
}
```
Ответ (200):

```json

{
  "id": "uuid-string",
  "name": "Иван Петров",
  "email": "ivan@example.com",
  "age": 26
}
```
Ошибка (401):

```
authorization error
```
**Тестирование**
Запустите тесты:

```bash

cargo test
```
Тесты включают интеграционные проверки API и модульные тесты сервиса.

**Структура проекта**:
src/main.rs: Запуск сервера и настройка.</p>
src/controllers/: Обработчики HTTP-запросов.</p>
src/services/: Бизнес-логика.</p>
src/repositories/: Взаимодействие с базой данных.</p>
src/middleware/: Проверка JWT.</p>
src/models/: Структуры данных.</p>
src/errors.rs: Обработка ошибок.</p>
migrations/: SQL-миграции.</p>
docker-compose.yml: Конфигурация PostgreSQL.</p>
start_postgres.sh: Скрипт для запуска базы.</p>

---

### Пояснения к тестам и README

#### Тесты (`tests/integration.rs` и `tests/service.rs`)
- **Интеграционные тесты** (`tests/integration.rs`):
  - Проверяют эндпоинты через HTTP-запросы с `reqwest`.
  - Создают тестовую базу, очищают её перед каждым тестом.
  - Тестируют создание, авторизацию (успешную и неуспешную) и обновление пользователя.
  - Проверяют коды ответа (200, 401) и тело ответа.
- **Модульные тесты** (`tests/service.rs`):
  - Проверяют `UserService` с mock-репозиторием через `mockall`.
  - Тестируют создание и авторизацию пользователя.
  - Изолированы от базы данных.# webapi
